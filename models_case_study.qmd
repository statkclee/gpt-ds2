---
editor_options: 
  chunk_output_type: console
editor: 
  markdown: 
    wrap: 72
---


# 사례: 시군구 소멸 {#sec-population-growth}

통계청에서 제공하는 연도별 인구데이터를 바탕으로 2005년부터 2022년까지 인구변동 데이터를 바탕으로 시군별 인구변동에 대해 이해한다.

[국가통계포털, KOSIS](http://kosis.kr/)에서 "통계표" 검색창에 "도시지역 인구현황(시군구)" 입력하게 되면 2005년부터 2016까지 시군구별 인구데이터를 받아올 수 있다. [직접 다운로드 링크](https://kosis.kr/statHtml/statHtml.do?orgId=460&tblId=TX_315_2009_H1001&vw_cd=MT_ZTITLE&list_id=315_31502_008&seqNo=&lang_mode=ko&language=kor&obj_var_id=&itm_id=&conn_path=MT_ZTITLE)

![국가통계포털에서 다운받은 전체기간 도시지역 인구현황(시군구) 데이터](images/kosis_excel.jpg){#fig-kosis-excel}


통계청 KOSIS에서 시군구별 인구데이터를 다운로드하고 전처리한다. 
시군구 간 인구 편차가 큰 문제를 파악하고, 이를 해결하기 위해 티블 자료구조와 함수형 프로그래밍을 도입한다.
시군구별로 선형회귀모형을 적용하고 broom 패키지를 사용하여 데이터와 모형 결과를 결합한다.
급성장/역성장 시군구를 파악하기 위해 결정계수와 회귀계수를 기준으로 상위/하위 5개 시군구를 추출한다.
마지막으로 급성장/역성장 시군구의 인구 변화를 시각화하여 결과를 분석한다.

```{mermaid}
graph LR
   classDef emphasize fill:#f9d423,stroke:#333,stroke-width:2px;
   classDef grayStyle fill:#f0f0f0,stroke:#333,stroke-width:2px;
   
   subgraph start["데이터 준비"]
       A["통계청 시군구별<br>인구데이터"] --> B(데이터 전처리)
       class A grayStyle
       class B grayStyle
   end
   
   start --> C
   
   subgraph problem["문제 해결"]
       direction TB
       C["시군구<br>인구편차"] --> E["티블 +<br>함수형<br>프로그래밍"]
       E --> G["시군구별<br>선형회귀모형<br>broom 패키지"]
       class E emphasize;
       class C grayStyle
       class G grayStyle
   end
   
   subgraph 결과_분석 [결과 분석]
       G --> I{"급성장/역성장<br>시군구 파악"}
       I -->|"결정계수,<br>회귀계수"| J["상위 5개<br>시군구 추출"]
       I -->|"결정계수,<br>회귀계수"| K["하위 5개<br>시군구 추출"]
       class I grayStyle
       class J grayStyle
       class K grayStyle
   end
   
   subgraph 시각화
       J --> L["급/역 성장<br>시군구<br>인구 변화<br>시각화"]
       K --> L
       class L grayStyle
   end
   
   style start fill:#f0f0f0,stroke:#333,stroke-width:2px
   style problem fill:#f0f0f0,stroke:#333,stroke-width:2px
   style 결과_분석 fill:#f0f0f0,stroke:#333,stroke-width:2px
   style 시각화 fill:#f0f0f0,stroke:#333,stroke-width:2px
```


## 시군구 인구변동 {#r-population-by-sigun}

인구변동이 많은 시군 통계 분석을 위해 필요한 팩키지를 불러 읽어온다.
통계청 KOSIS에서 다운로드 받은 파일을 `data` 폴더 아래 저장하고 나서, 전처리 작업을 수행한다.
서울특별시를 포함한 광역시에 포함된 군은 데이터 분석에 제외할 것이기 때문에 `stringr` 정규표현식 기능을 
활용하여 깔끔하게 향후 데이터분석을 위한 데이터프레임으로 정리한다.

``` {r}
#| label: r-population-growth-data
# 0. 환경설정 -----------
library(tidyverse)
library(readxl)

# 1. 데이터 가져오기 ---------

kor_raw <- read_excel("data/도시지역_인구현황_시군구__20240331111602.xlsx", sheet="데이터", skip=0) 

# 2. 데이터 전처리 ---------
kor_tbl <- kor_raw %>% 
  # 변수명 정리
  janitor::clean_names(ascii = FALSE) |> 
  # 2 행으로 구성된 칼럼 정리
  slice(2:n()) |> 
  # 연도별 인구수 자료 구조 변환
  pivot_longer(cols = starts_with("x"), names_to = "연도", values_to = "인구수") |> 
  # 변수명 확정
  set_names(c("시도명", "시군구", "연도", "인구수")) |> 
  # 결측값 채워넣기
  fill(시도명) |>
  # 시군구 중복, 소계 제거
  filter(시군구 != "소계") |> 
  filter(!시군구 %in% c("강원도", "경기도", "경상남도", "경상북도", "광주광역시", 
                     "대구광역시", "대전광역시", "부산광역시", "서울특별시", 
                     "세종특별자치시", "울산광역시", "인천광역시", "전라남도",
                     "전라북도", "제주특별자치도", "충청남도", "충청북도")) |> 
  # 자료형 변환
  mutate(연도 = parse_number(연도),
         인구수 = parse_number(인구수)) |> 
  # 2005년 인구 데이터만 있음 -- 제거 
  filter(!시군구 %in% c("북제주군", "남제주군"))

kor_tbl
```

## 문제 파악 {#r-population-by-sigun-problem}

대한민국 시군구이 `r kor_tbl |> count(시도명, 시군구) |> nrow()` 이기 때문에 인구변동이 많은 시군을 추출하기 위해서 
수도권 시군구는 백만명 근처이고 가장 작은 울릉군은 2016년 기준 10,001 명이라 편차가 매우 크다.
따라서, 이를 시각화를 하게 되면 문제점이 한눈에 파악된다.

``` {r}
#| label: fig-population-growth-problem
#| fig-cap: 전체 시군구 인구수 변화
kor_tbl %>% 
  ggplot(aes(x=연도, y=인구수, color=시군구, group=시군구)) +
    geom_point() +
    geom_line() +
    theme_minimal() +
    scale_y_log10(labels=scales::comma) +
    theme(legend.position = "none") +
    labs(x="", y="인구수", title="시군 인구수 년도별 변화(2005 - 2022)")
```

## 문제해결 {#r-population-by-sigun-solution}

이러한 문제점에 대해 가장 많이 활용되는 기법이 자료구조로 티블(tibble)을 도입하고,
데이터 분석을 위한 방법으로 함수형 프로그래밍을 조합하는 것이다.

### 티블 자료구조 {#r-population-by-sigun-solution-tibble}

데이터프레임을 기존 폭넓은(wide) 형태를 긴(long) 형태로 변환하고 이를 `nest()`를 적용시키면
함수형 프로그램을 적용시킬 수 있는 자료구조가 된다.
더불어, 선형회귀모형을 각 시군별로 적용시킬 예정이라 회귀모형 함수도 생성시켜 둔다.

그리고 나서 전체 시군별로 연도별 인구변화를 회귀분석으로 수행하여 수행결과를 `broom` 팩키지의
`tidy`, `glance`, `augment` 함수를 활용하여 데이터와 모형분석결과를 결합시킨다.

``` {r}
#| label: r-population-by-sigun-solution
kor_sigun_tbl <- kor_tbl %>% 
  group_by(시도명, 시군구) %>% 
  nest()

## 4.2. 모형 - 선형회귀모형
sigun_model <- function(df) {
  lm(인구수 ~ 연도, data=df)
}

## 4.3. 데이터 + 모형 결합
kor_sigun_mod <- kor_sigun_tbl %>% 
  mutate(model = map(data, sigun_model)) %>% 
  mutate(
    tidy    = map(model, broom::tidy),
    glance  = map(model, broom::glance),
    결정계수 = glance %>% map_dbl("r.squared"),
    augment = map(model, broom::augment),
    회귀계수    = map(tidy, ~ .x %>% filter(term == "연도") %>% select(estimate)) 
  ) |> 
  mutate(회귀계수 = map_dbl(회귀계수, ~ .x %>% pull(estimate))) |> 
  ungroup()

kor_sigun_mod |> 
  select(시도명, 시군구, 결정계수, 회귀계수) |> 
  arrange(desc(결정계수))
```

### 급/역 성장 시군 {#r-population-by-sigun-solution-rsquare}

회귀분석 결정계수($R^2$)기준 인구가 연도별로 높은 상관관계를 갖는 시군과 그렇지 않는 상위 하위 5개 시군을 뽑아 시각화 해보자.

회귀분석 결정계수($R^2$)기준이 아닌 회귀계수($\beta_1$)를 기준으로 상위 5개, 하위 5개 시군을 뽑아 
연도별 인구변화를 시각화해보자.

``` {r}
#| label: fig-population-growth-visualization
#| fig-cap: 급성장, 역성장 시군구 인구수 변화 시각화

## 급성장, 역성장 시군구 추출
positive_growth_sigun_tbl <- kor_sigun_mod %>% 
  filter(회귀계수 > 0) |> 
  top_n(5, 결정계수) %>% 
  unnest(data) %>% 
  mutate(구분="급성장")

negative_growth_sigun_tbl <- kor_sigun_mod %>% 
  filter(회귀계수 < 0) |> 
  top_n(5, 결정계수) %>% 
  unnest(data) %>% 
  mutate(구분="역성장")

growth_sigun_tbl <- bind_rows(positive_growth_sigun_tbl, negative_growth_sigun_tbl)

negative_growth_sigun_tbl |> tail()

## 급성장, 역성장 시군구 인구수 변화 시각화
growth_sigun_tbl %>% 
  mutate(구분 = factor(구분)) %>% 
  mutate(연도 = make_date(year=연도)) %>% 
  ggplot(aes(x=연도, y=인구수, color=구분, group=시군구)) +
    geom_point() +
    geom_line() +
    theme_minimal() +
    scale_y_log10(labels=scales::comma) +
    scale_x_date(date_labels = "%y") +
    theme(legend.position = "none") +
    facet_wrap(구분~시군구, nrow=2, scale="fixed") +
    labs(x=NULL, 
         y="인구수", 
         title="시군구 인구수 년도별 변화(2005 - 2022)") +
    scale_color_manual(values=c("역성장"="red", "급성장"="blue"))
```


